# 任务转移同步机制测试

## 实现总结

我们已经成功实现了"任务转移同步机制"，具体包括：

### 1. 添加转移标记字段
- 在 `UploadFileInfo` 接口中添加了 `transferredToBackground?: boolean` 字段
- 用于标记任务是否已从前台转移到后台

### 2. 修改上传逻辑
- 在 `uploadFileToTOS` 方法中添加了状态更新函数 `updateStatus`
- 根据 `transferredToBackground` 标记决定更新前台还是后台状态
- 避免了重复上传的问题

### 3. 修改关闭逻辑
- 在 `UploadFilesDrawer` 的 `handleClose` 方法中
- 为转移到后台的任务添加 `transferredToBackground: true` 标记

### 4. 修改后台任务处理
- 在 `startBackgroundUpload` 方法中
- 对于已转移的任务，跳过 TOS 上传步骤
- 添加等待机制，确保 TOS 上传完成后再创建素材

## 工作流程

### 正常流程（用户不关闭窗口）
1. 用户选择文件 → 开始上传
2. 前台任务执行 `uploadFileToTOS`
3. 更新前台状态 `uploadFiles`
4. 上传完成后创建素材

### 转移流程（用户关闭窗口）
1. 用户选择文件 → 开始上传
2. 用户关闭窗口 → 添加 `transferredToBackground: true` 标记
3. 任务添加到 `backgroundTasks`
4. 前台任务继续执行，但更新后台状态
5. 后台任务等待 TOS 上传完成
6. 创建素材

## 优势

1. **避免重复上传**：前台任务继续执行，不会重复上传到 TOS
2. **状态同步**：前台任务完成后自动更新后台任务状态
3. **用户体验好**：用户可以立即关闭窗口，不需要等待
4. **资源节约**：不会浪费网络和存储资源
5. **实现简洁**：只需要一个标记字段和状态判断逻辑

## 测试场景

### 场景1：正常上传（不关闭窗口）
- 选择文件 → 开始上传 → 等待完成 → 创建素材
- 预期：正常完成，状态更新到 `uploadFiles`

### 场景2：转移上传（关闭窗口）
- 选择文件 → 开始上传 → 关闭窗口 → 等待完成
- 预期：前台任务继续执行，状态更新到 `backgroundTasks`

### 场景3：混合场景
- 选择多个文件 → 部分完成 → 关闭窗口
- 预期：已完成的任务立即创建素材，未完成的任务转移到后台

## 注意事项

1. 转移标记只在关闭窗口时设置
2. 前台任务和后台任务使用相同的 `uploadFileToTOS` 方法
3. 状态更新通过 `updateStatus` 函数统一处理
4. 后台任务会等待前台任务完成后再创建素材
